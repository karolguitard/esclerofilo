<script>
  const map = L.map('map').setView([-33.5, -71], 7.5);

  // üó∫Ô∏è Capa base
  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Tiles ¬© Esri' }
  ).addTo(map);

  // üîπ Cargar pol√≠gono (GeoJSON local)
  fetch('ASP_Estado.geojson')
    .then(response => response.json())
    .then(data => {
      const aspLayer = L.geoJSON(data, {
        style: {
          color: 'red',
          weight: 2,
          fillColor: 'orange',
          fillOpacity: 0.2
        },
        onEachFeature: function (feature, layer) {
          layer.bindPopup("Pol√≠gono ASP_Estado");
        }
      }).addTo(map);

      map.fitBounds(aspLayer.getBounds());
    })
    .catch(error => console.error('Error cargando GeoJSON:', error));

  // üîπ Sitios de estudio
  const sitios = [
    { nombre: "Aguas Claras", coord: [-32.56368, -71.4106], datos: {"Vivos": 78.8, "Muertos": 21.2} },
    { nombre: "Lago Pe√±uelas", coord: [-33.17277, -71.429211], datos: {"Vivos": 94.4, "Muertos": 5.6} },
    { nombre: "Altos de Cantillana", coord: [-33.850864, -70.97967], datos: {"Vivos": 83.3, "Muertos": 16.7} },
    { nombre: "Chicauma", coord: [-33.19391, -70.9486], datos: {"Vivos": 80.1, "Muertos": 19.9} },
    { nombre: "Palmas de Cocal√°n", coord: [-34.21035, -71.12764], datos: {"Vivos": 90, "Muertos": 10} },
    { nombre: "R√≠o Clarillo", coord: [-33.72811, -70.49071], datos: {"Vivos": 81.1, "Muertos": 18.9} },
    { nombre: "PN La Campana", coord: [-33.004057, -71.126041], datos: {"Vivos": 79.9, "Muertos": 20.1} }
  ];

  sitios.forEach((sitio, idx) => {
    const marker = L.marker(sitio.coord).addTo(map);
    const chartId = `chart-${idx}`;
    const popupContent = `
      <b>${sitio.nombre}</b><br>
      <div id="${chartId}" class="chart-container"></div>
    `;
    marker.bindPopup(popupContent);

    marker.on("popupopen", () => {
      const categorias = Object.keys(sitio.datos);
      const valores = Object.values(sitio.datos);
      const trace = { x: categorias, y: valores, type: 'bar', marker: { color: ['#2ca02c','#1f77b4'] } };
      const layout = { margin: {t:30, l:30, r:10, b:30}, title: "Categor√≠as" };
      Plotly.newPlot(chartId, [trace], layout, {displayModeBar: false});
    });
  });
</script>
