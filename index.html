<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Mapa NDVI</title>

    <!-- Cargar Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ></script>

    <!-- Cargar Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      body { margin: 0; }
      #map { height: 100vh; width: 100%; }
      .chart-container { width: 250px; height: 200px; }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
      // Crear mapa base
      const map = L.map('map').setView([-33.5, -71], 7.5);

      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles 춸 Esri' }
      ).addTo(map);

      // 游댳 Cargar pol칤gono (GeoJSON local)
      fetch('ASP_Estado.geojson')
        .then(response => response.json())
        .then(data => {
          const aspLayer = L.geoJSON(data, {
            style: {
              color: 'red',
              weight: 2,
              fillColor: 'orange',
              fillOpacity: 0.2
            },
            onEachFeature: function (feature, layer) {
              layer.bindPopup("Pol칤gono ASP_Estado");
            }
          }).addTo(map);

          map.fitBounds(aspLayer.getBounds());
        })
        .catch(error => console.error('Error cargando GeoJSON:', error));

      // 游댳 Sitios de estudio
      const sitios = [
        { nombre: "Aguas Claras", coord: [-32.56368, -71.4106], datos: {"Vivos": 78.8, "Muertos": 21.2} },
        { nombre: "Lago Pe침uelas", coord: [-33.17277, -71.429211], datos: {"Vivos": 94.4, "Muertos": 5.6} },
        { nombre: "Altos de Cantillana", coord: [-33.850864, -70.97967], datos: {"Vivos": 83.3, "Muertos": 16.7} },
        { nombre: "Chicauma", coord: [-33.19391, -70.9486], datos: {"Vivos": 80.1, "Muertos": 19.9} },
        { nombre: "Palmas de Cocal치n", coord: [-34.21035, -71.12764], datos: {"Vivos": 90, "Muertos": 10} },
        { nombre: "R칤o Clarillo", coord: [-33.72811, -70.49071], datos: {"Vivos": 81.1, "Muertos": 18.9} },
        { nombre: "PN La Campana", coord: [-33.004057, -71.126041], datos: {"Vivos": 79.9, "Muertos": 20.1} }
      ];

      // A침adir marcadores con popups din치micos
      sitios.forEach((sitio, idx) => {
        const marker = L.marker(sitio.coord).addTo(map);
        const chartId = `chart-${idx}`;
        const popupContent = `
          <b>${sitio.nombre}</b><br>
          <div id="${chartId}" class="chart-container"></div>
        `;
        marker.bindPopup(popupContent);

        marker.on("popupopen", () => {
          const categorias = Object.keys(sitio.datos);
          const valores = Object.values(sitio.datos);
          const trace = {
            x: categorias,
            y: valores,
            type: 'bar',
            marker: { color: ['#2ca02c','#1f77b4'] }
          };
          const layout = {
            margin: {t:30, l:30, r:10, b:30},
            title: "Categor칤as"
          };
          Plotly.newPlot(chartId, [trace], layout, {displayModeBar: false});
        });
      });
    </script>
  </body>
</html>
