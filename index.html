<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mapa con Imágenes y Gráficos</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
      .popup-img {
        width: 240px;
        border-radius: 8px;
        margin-bottom: 6px;
      }
      .chart-container {
        width: 250px;
        height: 180px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
      // Crear mapa centrado
      const map = L.map("map").setView([-33.5, -71], 8);

      // Capa base
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
        { attribution: "Tiles © Esri" }
      ).addTo(map);

      // Sitios de estudio
      const sitios = [
        {
          nombre: "Aguas Claras",
          coord: [-32.56368, -71.4106],
          imagen: "https://raw.githubusercontent.com/karolguitard/esclerofilo/main/images/zap1.jpg",
          datos: { Resistente: 0.45, Recuperado: 0.35, "No recuperado": 0.20 }
        },
        {
          nombre: "La Campana",
          coord: [-33.004057, -71.126041],
          imagen: "https://raw.githubusercontent.com/karolguitard/esclerofilo/main/images/zap2.jpg",
          datos: { Resistente: 0.30, Recuperado: 0.50, "No recuperado": 0.20 }
        },
        {
          nombre: "Altos de Cantillana",
          coord: [-33.850864, -70.97967],
          imagen: "https://raw.githubusercontent.com/karolguitard/esclerofilo/main/images/zap1.jpg",
          datos: { Resistente: 0.40, Recuperado: 0.40, "No recuperado": 0.20 }
        }
      ];

      // Agregar puntos al mapa
      sitios.forEach((sitio, idx) => {
        const chartId = `chart-${idx}`;
        const popupHTML = `
          <div>
            <h4>${sitio.nombre}</h4>
            <img src="${sitio.imagen}" class="popup-img" alt="${sitio.nombre}">
            <div id="${chartId}" class="chart-container"></div>
          </div>
        `;

        const marker = L.marker(sitio.coord).addTo(map).bindPopup(popupHTML);

        marker.on("popupopen", () => {
          const categorias = Object.keys(sitio.datos);
          const valores = Object.values(sitio.datos);

          const trace = {
            x: categorias,
            y: valores,
            type: "bar",
            marker: { color: ["#1f77b4", "#2ca02c", "#d62728"] }
          };

          const layout = {
            title: "",
            margin: { t: 10, b: 30, l: 30, r: 10 },
            yaxis: { title: "Proporción", range: [0, 1] }
          };

          Plotly.newPlot(chartId, [trace], layout, { displayModeBar: false });
        });
      });
    </script>
  </body>
</html>
